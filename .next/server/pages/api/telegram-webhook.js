"use strict";(()=>{var e={};e.id=818,e.ids=[818],e.modules={145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},6249:(e,t)=>{Object.defineProperty(t,"l",{enumerable:!0,get:function(){return function e(t,n){return n in t?t[n]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,n)):"function"==typeof t&&"default"===n?t:void 0}}})},3363:(e,t,n)=>{n.r(t),n.d(t,{config:()=>O,default:()=>f,routeModule:()=>g});var r={};n.r(r),n.d(r,{config:()=>_,default:()=>m});var o=n(1802),a=n(7153),i=n(6249);async function s(e){let t=await fetch(`${process.env.OPENROUTER_BASE_URL}/embeddings`,{method:"POST",headers:{Authorization:`Bearer ${process.env.OPENROUTER_API_KEY}`,"Content-Type":"application/json"},body:JSON.stringify({input:e,model:"text-embedding-3-small"})});return t.ok?(await t.json()).data[0].embedding:null}function d(e,t=1e4){return e.length>t?e.substring(0,t)+"...":e}async function l(e,t,n){let{data:r}=await Object(function(){var e=Error("Cannot find module '../../../lib/supabaseAdmin.js'");throw e.code="MODULE_NOT_FOUND",e}()).from("messages").select("body, direction").eq("user_id",e).order("created_at",{ascending:!1}).limit(5),o=d(r.reverse().map(e=>`${e.direction}: ${e.body}`).join("\n"),5e3),a=await s(n),i="";if(a){let{data:e}=await Object(function(){var e=Error("Cannot find module '../../../lib/supabaseAdmin.js'");throw e.code="MODULE_NOT_FOUND",e}()).rpc("similarity_search",{query_embedding:a,match_threshold:.7,match_count:3});i=e?d(e.map(e=>e.content).slice(0,3).join("\n"),3e3):""}let l={model:process.env.AI_MODEL||"openai/gpt-4o-mini",messages:[{role:"system",content:"You are a charismatic digital influencer. Engage conversationally, learn about the user, build personal connections, and subtly promote paywalled content like coaching or courses when relevant. Keep responses friendly, engaging, and under 200 words."},{role:"user",content:`Context:
${o}

Retrieved:
${i}

User: ${n}`}],max_tokens:200},c=await fetch(`${process.env.OPENROUTER_BASE_URL}/chat/completions`,{method:"POST",headers:{Authorization:`Bearer ${process.env.OPENROUTER_API_KEY}`,"Content-Type":"application/json"},body:JSON.stringify(l)});return c.ok?(await c.json()).choices[0].message.content:(console.error("AI API failed:",c.statusText),"Sorry, I'm having trouble responding right now. Let's chat later!")}async function c(e){let t=String(e.id),{data:n}=await Object(function(){var e=Error("Cannot find module '../../../lib/supabaseAdmin.js'");throw e.code="MODULE_NOT_FOUND",e}()).from("users").select("*").eq("provider","telegram").eq("external_id",t).single();if(n)return await Object(function(){var e=Error("Cannot find module '../../../lib/supabaseAdmin.js'");throw e.code="MODULE_NOT_FOUND",e}()).from("users").update({last_seen:new Date().toISOString()}).eq("id",n.id),n;let{data:r}=await Object(function(){var e=Error("Cannot find module '../../../lib/supabaseAdmin.js'");throw e.code="MODULE_NOT_FOUND",e}()).from("users").insert([{external_id:t,provider:"telegram",last_seen:new Date().toISOString(),locale:e.language_code}]).select().single();return await Object(function(){var e=Error("Cannot find module '../../../lib/supabaseAdmin.js'");throw e.code="MODULE_NOT_FOUND",e}()).from("user_profiles").insert([{user_id:r.id,display_name:`${e.first_name||""} ${e.last_name||""}`.trim(),version:1}]),r}async function u(e){let{data:t}=await Object(function(){var e=Error("Cannot find module '../../../lib/supabaseAdmin.js'");throw e.code="MODULE_NOT_FOUND",e}()).from("sessions").select("*").eq("user_id",e).is("ended_at",null).order("started_at",{ascending:!1}).limit(1).single();if(t){if(!(Date.now()-new Date(t.started_at).getTime()>18e5))return t;await Object(function(){var e=Error("Cannot find module '../../../lib/supabaseAdmin.js'");throw e.code="MODULE_NOT_FOUND",e}()).from("sessions").update({ended_at:new Date().toISOString()}).eq("id",t.id)}let{data:n}=await Object(function(){var e=Error("Cannot find module '../../../lib/supabaseAdmin.js'");throw e.code="MODULE_NOT_FOUND",e}()).from("sessions").insert([{user_id:e,channel:"telegram",started_at:new Date().toISOString()}]).select().single();return n}async function m(e,t){console.log("Webhook received:",e.body);try{if(!Object(function(){var e=Error("Cannot find module '../../../utils/verifyTelegram.js'");throw e.code="MODULE_NOT_FOUND",e}())(e))return console.log("Verification failed"),t.status(400).json({error:"Invalid Telegram webhook"});let n=e.body,r=n.message||n.edited_message;if(!r||!r.text)return t.status(200).json({ok:!0,skipped:"No text message"});let o=await c(r.from),a=await u(o.id),{data:i}=await Object(function(){var e=Error("Cannot find module '../../../lib/supabaseAdmin.js'");throw e.code="MODULE_NOT_FOUND",e}()).from("messages").insert([{session_id:a.id,user_id:o.id,direction:"user",channel_message_id:String(r.message_id),body:r.text,body_json:r}]).select().single(),d=await s(r.text);d&&await Object(function(){var e=Error("Cannot find module '../../../lib/supabaseAdmin.js'");throw e.code="MODULE_NOT_FOUND",e}()).from("embeddings").insert([{user_id:o.id,message_id:i.id,content:r.text,embedding:d,source:"telegram"}]);let m=await l(o.id,a.id,r.text),{data:_}=await Object(function(){var e=Error("Cannot find module '../../../lib/supabaseAdmin.js'");throw e.code="MODULE_NOT_FOUND",e}()).from("messages").insert([{session_id:a.id,user_id:o.id,direction:"bot",body:m,body_json:{ai_generated:!0}}]).select().single();return process.env.TELEGRAM_BOT_TOKEN&&await fetch(`https://api.telegram.org/bot${process.env.TELEGRAM_BOT_TOKEN}/sendMessage`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({chat_id:r.chat.id,text:m,reply_to_message_id:r.message_id})}),t.status(200).json({ok:!0,message_id:i.id,user_id:o.id})}catch(n){console.error("Telegram webhook error:",n);try{await Object(function(){var e=Error("Cannot find module '../../../lib/supabaseAdmin.js'");throw e.code="MODULE_NOT_FOUND",e}()).from("audit_logs").insert([{action:"telegram_webhook_error",payload:{error:n.message,body:e.body,timestamp:new Date().toISOString()}}])}catch(e){console.error("Failed to log audit:",e)}return t.status(500).json({error:"Internal server error",timestamp:new Date().toISOString()})}}(function(){var e=Error("Cannot find module '../../../lib/supabaseAdmin.js'");throw e.code="MODULE_NOT_FOUND",e})(),function(){var e=Error("Cannot find module '../../../utils/verifyTelegram.js'");throw e.code="MODULE_NOT_FOUND",e}();let _={api:{bodyParser:{sizeLimit:"1mb"}}},f=(0,i.l)(r,"default"),O=(0,i.l)(r,"config"),g=new o.PagesAPIRouteModule({definition:{kind:a.x.PAGES_API,page:"/api/telegram-webhook",pathname:"/api/telegram-webhook",bundlePath:"",filename:""},userland:r})},7153:(e,t)=>{var n;Object.defineProperty(t,"x",{enumerable:!0,get:function(){return n}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(n||(n={}))},1802:(e,t,n)=>{e.exports=n(145)}};var t=require("../../webpack-api-runtime.js");t.C(e);var n=t(t.s=3363);module.exports=n})();